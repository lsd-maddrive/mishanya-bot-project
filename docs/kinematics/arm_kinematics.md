<p align="center">
<img src="Figure/Arm.png">
</p>
<details>
<summary>Обозначения и значения параметров</summary>

Значение параметров взяты [отсюда](https://github.com/lsd-maddrive/mishanya-bot-project/blob/develop/docs/kinematics/dimensions.md)

| Обозначение| Смысл| Значение, ед. изм.|
| -------------------|:---------------:| ---------:|
| *X,Y,Z / x,y,z*      | абсолютные координаты | м |
| *X',Y',Z' / x',y',z',X'',Y'',Z'' / x'',y'',z''*      | преобразованные координаты      |   м |
| <img src="Formul/theta1.png">, <img src="Formul/theta2.png">, <img src="Formul/theta3.png"> | углы поворота звеньев манипулятора      |    рад |
| *L1*      | Длина первого звена | 0.258 м |
|   *L2*   | Длина второго звена | 0.236 м |

</details>

Прямая кинематика:

<img src="Formul/Hand_dir_kinematic.png">

Обратная кинематика:

Для начала введём несколько обозначений:
<img src="Formul/A_2x0.png">, <img src="Formul/B_2y0.png"> , <img src="Formul/C_2z0.png"> , <img src="Formul/d_x02_y02_z02.png"> , где <img src="Formul/x0_y0_z0.png"> - координаты желаемой точки.
Далее обозначим:
###
<img src="Formul/D_L12_L22_d.png">

###

<img src="Formul/ym12.png">

###

<img src="Formul/xm12_lin.png"> или <img src="Formul/xm12_sqrt.png">

Окончательно:

<img src="Formul/Hand_inv_kinematic.png">

###
<details>
<summary>Вывод уравнений</summary>

Для прямой кинематики:

Для начала отметим, что точки a1 и a2 всегда лежат в одной плоскости, которую мы будем называть плоскостью манипулятора. Внутри этой плоскости они однозначно связаны через угол <img src="Formul/theta2.png">, поэтому сразу вычислим эту связь.

Первое звено L1 закреплёно одним концом на плече в точки О и поворачивается на угол <img src="Formul/theta1.png">,
второе звено L2 крепится к концу первого звена в точке a1 и поворачивается относительно него на угол <img src="Formul/theta2.png">.
Задавать мы пытаемся координаты конца второго звена - точки a2.

Найдём сначала положение точки a1 относительно точки крепления плеча:

<img src="Formul/XY_a1.png">

Далее положение точки a2 относительно точки a1:

<img src="Formul/X1Y1_a2.png">

Так как система координат, привязанная к точке a1 также вращается - учтём это в относитльном положении для точки a2. Расчёт коордиеат во вращающейся системе осуществляется с использованием матрицы поворота: умножаем предыдущую систему на матрицу поворота угла <img src="Formul/theta1.png">. Таким образом положение точки a2 относительно точки a1 в случае вращающейся системы координат получим:

<img src="Formul/X11Y11_a2.png">

Раскрыв правую часть и используя формулу косинуса и синуса суммы углов, получим:

<img src="Formul/X11Y11_a2_sys.png">

Если помимо вращение системы координат, привязанной к точки a1, учесть также смещение этой точки относительно начала глобальной системы координат, которое по сути равно координатам точки a1 в этой глобальной системе, окончательно получим:

<img src="Formul/XY_a2.png">

Далее заметим, что остальные углы лишь поворачивают эту плоскость вокруг какой-то произвольной оси. Для задания этих поворотов воспользуемся углами Эйлера. Они позволяют сложное вращательное движение в пространстве(у нас нет поступательных движений) представить как последовательное вращение вокруг определённых осей, что более простая задача. Все формулы были взяты [отсюда](https://ru.wikipedia.org/wiki/%D0%A3%D0%B3%D0%BB%D1%8B_%D0%AD%D0%B9%D0%BB%D0%B5%D1%80%D0%B0). Пускай начальное положение манипулятора лежит полностью в плоскости XY, причём так, что ось звена L1 сонаправлена с осью X, т.е. следующим образом:

<img src="Figure/Arm_start_position.png">

Сделали мы так, чтобы вращение вокруг звена L1 совпадало с вращением вокруг оси X, а не было вращением вокруг какой-то произвольно ориентированной в пространстве оси. Таким образом, сделав вращение сначала вокруг оси X на угол <img src="Formul/theta3.png"> из начального положения, а после из нового положения - вокруг оси Z на угол <img src="Formul/theta1.png">, мы получим полный поворот манипулятора с учётом всех углов. Формулы вращения вокруг осей системы координат известные и просты(ссылка выше), и представление сложного пространственного движения через последовательные более простые преобразования позволяет упростить задачу.

С учётом вышевыведенных формул, в начальном положении у нас <img src="Formul/theta1.png"> = 0, а <img src="Formul/theta2.png"> произвольный, получим:

<img src="Formul/Sys_start_position.png">

Далее мы нашу систему координат, как уже было сказано, поворачиваем вокруг оси X на угол <img src="Formul/theta3.png">. Тогда с учётом вида матрицы вращения вокруг оси X наше преобразование будет иметь вид:

<img src="Formul/Rot_X.png">

Получим:

<img src="Formul/x1_y1_z1.png">

После поворачиваем вокруг оси Z на угол <img src="Formul/theta1.png">. Тогда с учётом вида матрицы вращения вокруг оси Z наше преобразование будет иметь вид:

<img src="Formul/Rot_Z.png">

После перемножения получим формулу прямой кинематики, которая приведена в начале.

В силу громоздкости записи и вычислений был использован матлаб-скрипт [Hand_formul.m](Script/Hand_formul.m). Cкрипт выводит все символьные выражения.

Для обратной кинематики:

Для начала упростим задачу. Представим, что звено L1 может двигаться не только в плоскости но и вообще во всём пространстве(относительно точки плеча), тогда все возможные положения конца звена - точки локтя будут описывать сферу с радиусом L1 и центром в точке плеча(в центре системы координат). Далее, мы знаем, что точка хвата должна оказаться в желаемой точке, чьи координаты заданы, при этом точку хвата описывает координаты конца звена L2, которые в свою очередь определяются координатами локтя. Представим, что точка хвата достигла желаемой точки, тогда всё возможные положения точки локтя лежат на сфере радиуса L2 и с центром - желаемой точкой(мысленно поставим точку хвата в желамую точку и покрутим предплечьем(звеном L2) во все стороны). Таким образом положения точки локтя при осуществелении обеих условий(1. начало звена L1 зафиксировано в начале координат, 2. точка хвата лежит в желаемой точке, а точка локтя жёстко связана с ней через звено L2) будет лежать на перечении этих двух сфер. Найдём координаты этих точек, для этого нужно решить систему:

<img src="Formul/Two_sphere.png">

где первое уравнение описывает первую сферу, второе - вторую. <img src="Formul/x0_y0_z0.png"> - координаты желаемой точки.

Раскроем во втором уравнении скобки:

<img src="Formul/Quad_eq.png">

Вместо суммы квадратов координат можно поставить первое уравнение. Сумму квадратов координат желаемой точки обозначим за d. С учтом подстановок и обозначение перенесём всё влево:

<img src="Formul/Quad_eq_d.png">

Обозначим <img src="Formul/L22_L12_d.png"> за D. В итоге получим уравнение плоскости вида:

<img src="Formul/Plane.png">,

где <img src="Formul/A_2x0.png"> , <img src="Formul/B_2y0.png"> , <img src="Formul/C_2z0.png"> соответственно.

Вообще пересечением сфер является окружность, но так как сложно описать уравнение окружности, произвольно лежащей в пространстве, мы получили уравнение плоскости, в которой лежит нужная нам окружность. Так как из всей плоксоти нам нужны конкретные точки, а именно лежащие на сфере, мы должны совместно решить уравнение плоскости и уравнение какой-нибудь из сфер(возьмём первое для удобства)(кстати, система из уравнения плоскости и сферы как раз даёт уравнение окружности произвольно ориентированной в пространстве), также вспомним, что мы опустили условие, что звено L1 может двигаться только в плоскости, поэтому сразу добавим третьим уравнением - уравнение плоскости L1, так как этой плоскостью является XY, то её уравнением будет просто z = 0. В итоге получим:

<img src="Formul/Sphere_plane_z_zero.png">

Можем сразу подставить z=0 в два другим уравнения и получим:

<img src="Formul/Circle_line.png">

Из второго уравнения выразим x:

<img src="Formul/xy_line.png">

и подставим это в первое уравнение:

<img src="Formul/Circle_only_y.png">

<img src="Formul/Circle_only_y_2.png">

###

<img src="Formul/Circle_only_y_3.png">

###

<img src="Formul/Circle_only_y_4.png">

###

<img src="Formul/Quad_eq_for_y.png">

Отсюда можно найти решение - координату локтя:

<img src="Formul/ym12.png">

А по формулам полученным выше можно найти вторую координату:

<img src="Formul/xm12_lin.png">

или если нужно избежать возможное деление на ноль

<img src="Formul/xm12_sqrt.png">

Зная координаты локтя, можно найти угол поворота первого звена, как:

<img src="Formul/theta1_arctg.png">

Для нахождения угла <img src="Formul/theta3.png"> вспоним сначала, что это поворот плоскости манипулятора вокруг первого звена, значит нахождения этого угла можно поставить как задачу расчёта угла между плоскостями: исходной(XY) и новой(желаемой), которые имеют общую прямую пересечения(которая проходит через первое звено). Плоскость можно задавать с помощью координат нормали к этой плоскости. Для исходной плоскости это будет единичный вектор сонаправленный с осью Z. Для получения уравнения координат нормали к новой плоскости, построим сначала уравнение самой плоскости. Для этого используем уравнение:

<img src="Formul/det_matrix_xyz.png">

где вертикальные черты означают определитель, <img src="Formul/x13_y13_z13.png"> - координаты трёх точек, по которым строится плоскость. В качестве трёх точек возьмём начало координат, координаты локтя, желаемую точку, в итоге получим уравнение желамеой плоскости манипулятора:

<img src="Formul/My_plane.png">

коэффициенты при переменных - и будут координатами нормали к данной плоскости. Тогда мы можем воспользоваться формулой косинуса угла между пересекающимеся плоскостями по координатам их нормали:

<img src="Formul/cos_alpha_plane.png">

так как нам важен знак(четверть угла), то воспользуемся формулой:

<img src="Formul/cos_alpha_plane_out_mod.png">

Подставляя координаты наших нормалей получим:

<img src="Formul/cos_theta3.png">

Из-за громоздкости выражений и расчётов был использован скрипт для символьных выражений [Ang_plosk.m](Script/Ang_plosk.m), который выводит выражения выше. От арккосинуса перейдём к арктангенсу, так как он позволяет сократить выражение, а также имеет специлизированные функции, защищающие от случай деления на ноль. Для этого сделаем преобразование:

<img src="Formul/cos_theta3_sin.png">

Используем выражение:

<img src="Formul/sin_arctg.png">

Для этого сделаем преобразование:

<img src="Formul/Transform_sqrt.png">

<img src="Formul/Transform_sqrt_2.png">

минус в одной из скобок знаменателя был добавлен так как дробь стоит под квадратом, а в знаменателе корень, который не меняет знака

С учётом всех вышеперечисленных выражений, получим:

<img src="Formul/pi_theta3_arctg.png">

или

<img src="Formul/theta3_pi_arctg.png">

Для нахождения угла <img src="Formul/theta2.png"> достаточно знать, что он всегда лежит в плоскости манипулятора, а значит для его нахождения можно рассмотреть манипулятор как плоскую фигуру. Построим:

<img src="Figure/Arm_inv.png">

нужный нам угол составляет с углом <img src="Formul/betta.png"> 180 градусов. Угол <img src="Formul/betta.png"> мы можем найти из теоремы косинусов:

<img src="Formul/Law_of_cos.png">

###
<img src="Formul/betta_arccos.png">

Тогда с заменой <img src="Formul/r2.png"> на <img src="Formul/d.png"> получим:

<img src="Formul/theta2_pi_arccos.png">

</details>

###
Для проверки работоспособности можно воспользоваться скриптом [Proverka.m](Script/Proverka.m)